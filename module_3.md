# 3. Проектирование без данных

## Концептуальное проектирование

Обычно при концептуальное проектирование используют популярную модель [«сущность — связь» (ER-модель)](https://en.wikipedia.org/wiki/Entity%E2%80%93relationship_model).

> ER-модель (от англ. entity-relationship model, модель «сущность — связь») — модель данных, позволяющая описывать концептуальные схемы предметной области [(Википедия)](https://ru.wikipedia.org/wiki/ER-%D0%BC%D0%BE%D0%B4%D0%B5%D0%BB%D1%8C).

ER-модель используется при высокоуровневом (концептуальном) проектировании баз данных. С её помощью можно выделить ключевые сущности и обозначить связи, которые могут устанавливаться между этими сущностями. Проектирование можно разделить на несколько этапов.

### Этапы

- Выделение сущностей
- Определение связей
- Определение атрибутов сущности, а также типов данных и доменов
- Определение ключей для сущности
- Ограничение целостности

  - Допустимые значения
  - Разрешенные значения
  - Существующие значения

### Выделение типов сущностей

**Задача этапа:** выделить типы сущностей.

**Порядок решения:**

1. Провести интервью с различными группами будущих пользователей понять их _потребности и представления_ о предметной области.
2. Выделить типы сущностей. Например, при моделировании БД для хранения информации о сотрудниках, могут быть выделены сущности «сотрудник» или «отдел».
3. Отбросить ненужные сущности. Возможно, сохранить часть сущностей в виде атрибутов у других сущностей.
4. Дать установленным типам сущностей имена.

### Определение связей между сущностями

**Задача этапа:** определить связи и типы связей.

**Типы связей:**

- Один ко многим
- Многие к одному
- Многие ко многим (обычно реализуется с помощью дополнительной таблицы)
- Один к одному

**Кратность связей:**

- 1 (должна быть связана 1 сущность)
- 0..1 (должны быть связаны от 0 до 1 сущности)
- 0..n (должны быть связаны от 0 до n сущностей)
- 1..n (должны быть связаны от 1 до n сущностей)

**Порядок решения:**

1. Опредилить типы связей для каждого типа сущности
2. Определить кратность связей для каждой связи

### Определение атрибутов

**Задача этапа:** определить атрибуты (свойства) сущностей и связей.

**Порядок решения:**

1. Выделить атрибуты типов сущностей.
2. Выделить атрибуты связей.
3. Выбрать простые или составные атрибуты.
4. Дать установленным атрибутам имена.
5. Выбрать ключевый атрибутов (ключей).

   1. Определить ключевые атрибуты (один или несколько)
   2. Выбирается первичный ключ (простой, составной или синтетический)
   3. Для слабых сущностей (у которых нет совокупности атрибутов, которые могут быть уникальны в рамках БД, т.е. нет потенциального ключа) вводятся синтетические ключевые атрибуды (сгенерированный уникальный идентификатор)

### Проверка

1. Наличие связей типа «Один к одному» говорит о том, что эти сущности можно попробовать объединить в одну.
2. Проверить наличие избыточных связей.
3. Проверить выполнимость пользовательских операций.
4. Обсуждение с пользователями.

## Логическое проектирование

**Логическая модель содержит:**

- набор схем отношений
- первичные ключи
- внешние ключи

Если концептуальная схема описана в терминах семантической ER-модели, то переход к логической схеме можно реализовать по правилам.

**Правила перехода от концептуальной схема к логической схеме**

- Каждый простой тип сущности отображается в отношение
- Атрибута ER-модели отображаются в атрибуты отношений
- Компоненты уникального идентификатора отображаются в первичный ключ
- Связи «Один к одному» и «Один ко многим» отображаются в виде внешних ключей
- Связи «Многие ко многим» отображаются с созданием дополнительного отношения
- Сложные связи (более 2 типов сущностей) декомпозируются с выделением нового типа сущности
- Многозначные атрибуты декомпозируются с выделением нового типа сущности

## Физическое проектирование

> Физическое проектирование - это перенос логической модели в конкретную СУБД.

- Определение типо данных для атрибутов (с учетом особенностей СУБД)
- Определение допустимости неопределенных значени (Null и Not null)
- Выбор стратегии обработки исключительных ситуаций при попытках нарушения ссылочной целостности (каскадное удаление и т.д.)
- Уточнение названий таблиц и атрибутов
- Хранение и/или вычисление производных атрибутов
- Релизация ограничений целостности, процедурная обработка
- Формирование описания модели данных в рамках выбранной СУБД
- Формирование индексов
- Секционирование и партицирование

## SQL/DDL

### Создание схемы

```sql
CREATE SCHEMA IF NOT EXISTS `store` DEFAULT CHARACTER SET utf8;
```

### Создание доменов

Пример для PostgreSQL, так как в MySQL нет возможности определени домена.

```sql
CREATE DOMAIN SALE_STATUS AS VARCHAR(15)
    DEFAULT `new`
    CHECK(VALUE IN(`new`, `process`, `assembly`))
    CONSTRAINT SALE_STATUS_NOT_NULL CHECK (VALUE IS NOT NULL);
```

### Создание таблиц

Таблица `category` в базе данных `store`.

Первичный ключ - `id`.

```sql
CREATE TABLE IF NOT EXISTS `store`.`category` (
    `id` INT NOT NULL,
    `name` VARCHAR(255) NOT NULL,
    PRIMARY KEY(`id`))
    ENGINE = InnoDB,
    DEFAULT CHARACTER SET = utf8, #кодировка
    COLLATE = utf8_general_ci; #набор правил для сравнения строк
```

### Изменение таблиц

Происходит с помощью оператора `ALTER TABLE`. Изменять можно стоблцы и ограничения.

#### Добавление столбца

```sql
ALTER TABLE `store`.`sale`
    ADD COLUMN
        `is_exclusive_case` BOOLEAN NOT NULL DEFAULT 0;
```

#### Удаление столбца

```sql
ALTER TABLE `store`.`sale`
    DROP COLUMN `dt_created`,
    DROP FOREIGN KEY fk_order_status1,
    ADD COLUMN ts_modified TIMESTAMP ON UPDATE CURRENT_TIMESTAMP;
    ADD COLUMN sale_status VARCHAR(45) NOT NULL DEFAULT 'new'
        CHECK (VALUE IN('new', 'ready', 'steady'));
```
